{{- if .Values.rbac.create -}}
# Note: ServiceAccount is auto-created by kagent controller from MCPServer
# We only need to create the Role and bind it to the auto-created SA
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "kmeta-agent.fullname" . }}-role
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "kmeta-agent.rbacLabels" . | nindent 4 }}
rules:
  # Full access to Agent resources
  - apiGroups: ["kagent.dev"]
    resources: ["agents"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["kagent.dev"]
    resources: ["agents/status"]
    verbs: ["get", "list", "watch"]

  # Full access to ModelConfig resources
  - apiGroups: ["kagent.dev"]
    resources: ["modelconfigs"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

  # Full access to MCPServer resources
  - apiGroups: ["kagent.dev"]
    resources: ["mcpservers", "remotemcpservers"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

  # Read access to secrets (for validation)
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list"]

  # Ability to create RBAC resources for new agents
  - apiGroups: ["rbac.authorization.k8s.io"]
    resources: ["roles", "rolebindings"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

  # Service account management
  - apiGroups: [""]
    resources: ["serviceaccounts"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "kmeta-agent.fullname" . }}-rolebinding
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "kmeta-agent.rbacLabels" . | nindent 4 }}
subjects:
  # Bind to the ServiceAccount auto-created by kagent controller for the MCPServer
  - kind: ServiceAccount
    name: {{ .Values.mcpServer.name }}
    namespace: {{ .Values.namespace }}
roleRef:
  kind: Role
  name: {{ include "kmeta-agent.fullname" . }}-role
  apiGroup: rbac.authorization.k8s.io
{{- end }}
